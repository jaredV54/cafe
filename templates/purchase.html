{% extends 'layout.html' %}
{% block content %}

<section>
    <div>
        <div id="selected-products-section">
        
        </div>
        <div id="total-amount-section" style="display: none;">
            <h4>Total Amount: P<span id="total-amount">0.00</span></h4>
            <form id="transaction-form" method="POST" action="/purchase">
                <input type="hidden" name="user_id" value="{{ session.user_id }}">
                <input type="hidden" name="total_amount" id="form-total-amount" value="0">
                <input type="hidden" name="products" id="form-products" value="">
                <label for="cash-amount">Cash Amount: </label>
                <input type="number" id="cash-amount" name="cash_amount" min="0" step="0.01" required>
                <p id="cash-error" style="color: red; display: none;">Invalid cash amount. It must be positive and at least equal to the total amount.</p>
                <p>Change: P<span id="change-amount">0.00</span></p>
                <input type="hidden" name="change" id="form-change" value="0">
                <button type="submit" id="submit-button" disabled>Submit Transaction</button>
            </form>
        </div>
    </div>
    <div>
        <div class="purchase">
            <div id="category-container">
                <ul class="categories">
                    <li class="{% if selected_category == 'all' %}active{% endif %}">
                        <a href="?category=all">All</a>
                    </li>
                    <li class="{% if selected_category == 'hot-coffee' %}active{% endif %}">
                        <a href="?category=hot-coffee">Hot Coffee</a>
                    </li>
                    <li class="{% if selected_category == 'cold-coffee' %}active{% endif %}">
                        <a href="?category=cold-coffee">Cold Coffee</a>
                    </li>
                    <li class="{% if selected_category == 'pastries' %}active{% endif %}">
                        <a href="?category=pastries">Pastries</a>
                    </li>
                </ul>
            </div>

            <div>
                <input type="text" name="search-bar" id="search-query" placeholder="Search for an item...">
            </div>
            
            <ul>
                {% for product in products %}
                    {% if product['name'] %}
                    <li 
                        class="product-item"
                        data-id="{{ product['id'] }}"
                        data-name="{{ product['name']|replace("'", "\\'")|replace('\\', '\\\\') }}"
                        data-price="{{ product['price'] }}"
                        data-category="{{ product['category']|replace("'", "\\'")|replace('\\', '\\\\') }}"
                        data-available="{{ 'true' if product['is_available'] else 'false' }}"
                    >
                        <h4>{{ product['name'] }}</h4>
                        <p>P{{ '%.2f'|format(product['price']) }}</p>
                        <p>{{ "Available" if product['is_available'] else "Unavailable" }}</p>
                        <p>{{ product['category'] }}</p>
                    </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    </div>
</section>

<script>
    document.getElementById('search-query').addEventListener('input', function() {
        const query = this.value.toLowerCase();
        const products = document.querySelectorAll('.product-item');
        
        products.forEach(product => {
            const name = product.getAttribute('data-name').toLowerCase();
            if (name.includes(query)) {
                product.style.display = '';
            } else {
                product.style.display = 'none';
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
      const selectedProductsSection = document.getElementById('selected-products-section');
      const totalAmountElement = document.getElementById('total-amount');
      const totalAmountSection = document.getElementById('total-amount-section');
      const formTotalAmount = document.getElementById('form-total-amount');
      const formProducts = document.getElementById('form-products');
      const cashAmountInput = document.getElementById('cash-amount');
      const changeAmountElement = document.getElementById('change-amount');
      const formChange = document.getElementById('form-change');
      const cashErrorElement = document.getElementById('cash-error');
      const submitButton = document.getElementById('submit-button');
      const productItems = document.querySelectorAll('.product-item');
      const selectedProducts = {};

      productItems.forEach(item => {
          item.addEventListener('click', function () {
              const productId = this.getAttribute('data-id');
              const productName = this.getAttribute('data-name');
              const productPrice = parseFloat(this.getAttribute('data-price'));

              if (selectedProducts[productId]) {
                  removeProductFromSelectedSection(productId);
                  this.classList.remove('active_product');
              } else {
                  selectedProducts[productId] = {
                      id: productId,
                      name: productName,
                      price: productPrice,
                      quantity: 1
                  };
                  addProductToSelectedSection(productId);
                  this.classList.add('active_product');
              }
          });
      });

      function addProductToSelectedSection(productId) {
          const product = selectedProducts[productId];
          const productElement = document.createElement('div');
          productElement.classList.add('selected-product');
          productElement.setAttribute('data-id', productId);
          productElement.innerHTML = `
              <h4>${product.name}</h4>
              <p>Price: P${product.price.toFixed(2)}</p>
              <p>Quantity: <button class="decrement">-</button> <span class="quantity">${product.quantity}</span> <button class="increment">+</button></p>
              <p>Total: P<span class="total">${(product.price * product.quantity).toFixed(2)}</span></p>
              <button class="cancel">Cancel</button>
          `;
          selectedProductsSection.appendChild(productElement);

          productElement.querySelector('.increment').addEventListener('click', function () {
              updateQuantity(productId, 1);
          });

          productElement.querySelector('.decrement').addEventListener('click', function () {
              updateQuantity(productId, -1);
          });

          productElement.querySelector('.cancel').addEventListener('click', function () {
              removeProductFromSelectedSection(productId);
              document.querySelector(`.product-item[data-id="${productId}"]`).classList.remove('active_product');
          });

          updateTotalAmount();
      }

      function removeProductFromSelectedSection(productId) {
          delete selectedProducts[productId];
          const productElement = selectedProductsSection.querySelector(`.selected-product[data-id="${productId}"]`);
          if (productElement) {
              selectedProductsSection.removeChild(productElement);
          }
          updateTotalAmount();
      }

      function updateQuantity(productId, change) {
          const product = selectedProducts[productId];
          product.quantity += change;
          if (product.quantity < 1) {
              product.quantity = 1;
          }
          const productElement = selectedProductsSection.querySelector(`.selected-product[data-id="${productId}"]`);
          productElement.querySelector('.quantity').textContent = product.quantity;
          productElement.querySelector('.total').textContent = (product.price * product.quantity).toFixed(2);
          updateTotalAmount();
      }

      function updateTotalAmount() {
          let totalAmount = 0;
          const productsArray = [];
          for (const productId in selectedProducts) {
              const product = selectedProducts[productId];
              const subtotal = product.price * product.quantity;
              totalAmount += subtotal;
              productsArray.push({
                  id: product.id,
                  name: product.name,
                  price: product.price,
                  quantity: product.quantity,
                  subtotal: subtotal
              });
          }
          totalAmountElement.textContent = totalAmount.toFixed(2);
          formTotalAmount.value = totalAmount.toFixed(2);
          formProducts.value = JSON.stringify(productsArray);

          if (productsArray.length > 0) {
              totalAmountSection.style.display = 'block';
          } else {
              totalAmountSection.style.display = 'none';
          }

          updateChange();
      }

      cashAmountInput.addEventListener('input', updateChange);

      function updateChange() {
          const cashAmount = parseFloat(cashAmountInput.value) || 0;
          const totalAmount = parseFloat(formTotalAmount.value) || 0;
          const change = cashAmount - totalAmount;
          changeAmountElement.textContent = change.toFixed(2);
          formChange.value = change.toFixed(2);

          if (cashAmount >= totalAmount && cashAmount > 0) {
              cashErrorElement.style.display = 'none';
              submitButton.disabled = false;
          } else {
              cashErrorElement.style.display = 'block';
              submitButton.disabled = true;
          }
      }
  });
</script>
{% endblock %}